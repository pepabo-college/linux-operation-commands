# `sar`

- System Admin Reporter
- サーバの CPU, メモリ、IO など様々な情報を取得する
- cron でサーバ情報の履歴を保存している
  - `/etc/cron.d/sysstat` に cron 定義あり
  - `/etc/sysconfig/sysstat` の `HISTORY` で保存日数を設定する

## 基本コマンド

- まずはインストール
  - `yum install sysstat`

- `sar`
  - 過去 1 時間の CPU 全体の情報が出る

- 出力情報
  - user
    - ユーザが利用している割合
    - 上昇していると特定ユーザで CPU が消費されている可能性あり
      - `ps` でチェック
  - nice
    - nice 値を変更しているプロセスが利用している割合
      - プロセスの nice 値を上げると、CPU 割当の優先順位が上がる
  - system
    - カーネルが利用している割合
    - 上昇しているとコンテキストスイッチが頻発している可能性あり
  - iowait
    - IO 待ちになっている割合
    - 上昇しているとスラッシングや大きなファイルのコピーが発生している可能性あり
  - steal
    - ゲスト OS が割当要求したが割り当ててもらえなかった割合
  - idle
    - なにもしていない待機状態の割合

## オプション

- `-u`
  - CPU 全体の情報を表示
- `-u -P ALL`
  - マルチコア CPU の場合にコアごとの情報を表示
- `sar <オプション> <時間間隔> <表示時間>`
  - `<表示時間>` のあいだ、`<時間間隔>` ごとに表示する
- `-s <時間> -f <ログファイルのパス>`
  - ログ確認
  - 当月 1 日の 15:00 以降のデータを見たいときは次のコマンドを実行
  - `sar -u -s 15:00:00 -f /var/log/sysstat/sa01`

# `vmstat`

- Virtual Memory Statistics
- システム全体のメモリや CPU 使用率の確認
- ボトルネックが IO かメモリか CPU か、という切り分けに役立つ

## 基本コマンド

- `vmstat` で実行

### 出力情報の意味

メモリの単位はキロバイト。

- `procs` 欄
  - `r`: 実行キューに入っているプロセスの数
  - `b`: 処理ブロック中のプロセスの数
    - これが増えるとユーザからは重く感じる
- `memory` 欄
  - `swpd`: スワップ領域の使用量
  - `free`: 未使用メモリ量
  - `buff`: カーネルが使うバッファ領域の量
    - 歴史的にページキャッシュより古い
  - `cache`: キャッシュ領域の使用量
- `swap` 欄
  - `si`: スワップイン量
  - `so`: スワップアウト量
  - 基本は両方 0 が望ましい
- `io` 欄
  - `bi`: ブロックデバイスからの読込量
  - `bo`: ブロックデバイスへの書込量
- `system` 欄
  - `in`: 割り込み処理の回数
  - `cs`: コンテキストスイッチの回数
    - プロセス、スレッドの切り替え。これが増えるとユーザからは重く感じる
- `cpu` 欄
  - `us`: ユーザ処理の利用時間
  - `sy`: カーネル処理の利用時間
  - `wa`: IO 処理の待ち時間
  - `id`: アイドル時間

## オプション

- `sar <オプション> <時間間隔> <表示時間>`
  - `<表示時間>` のあいだ、`<時間間隔>` ごとに表示する
- `-t`
  - 時刻を追加で表示する
